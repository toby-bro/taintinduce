<!doctype html>
<html>
  <head>
    <title>TaintInduce Visualizer</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" type="image/svg+xml" id="favicon" />
    <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon" />
    <script>
      // Update favicon color based on user's theme preference
      function updateFavicon() {
        const isDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const color = isDark ? "#ffffff" : "#667eea"; // white for dark mode, purple for light mode

        // Load the SVG and update its color
        fetch("/static/arrow-progress.svg")
          .then((response) => response.text())
          .then((svgText) => {
            // Replace stroke and fill colors in the SVG
            const updatedSvg = svgText
              .replace(/stroke="[^"]*"/g, `stroke="${color}"`)
              .replace(/fill="[^"]*"/g, `fill="${color}"`);

            // Convert to data URI
            const svgBlob = new Blob([updatedSvg], { type: "image/svg+xml" });
            const url = URL.createObjectURL(svgBlob);

            // Update favicon
            const favicon = document.getElementById("favicon");
            favicon.href = url;
          })
          .catch(() => {
            // Fallback to original SVG if fetch fails
            console.log("Using default favicon");
          });
      }

      // Update on load
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", updateFavicon);
      } else {
        updateFavicon();
      }

      // Listen for theme changes
      window
        .matchMedia("(prefers-color-scheme: dark)")
        .addEventListener("change", updateFavicon);
    </script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 style="text-align: center">üîç TaintInduce Visualizer</h1>
        <p style="text-align: center">
          Interactive tool for visualizing and testing taint propagation rules
        </p>
        <div style="text-align: center; margin-top: 15px">
          <input
            type="file"
            id="ruleFileInput"
            accept=".json"
            style="display: none"
            onchange="handleRuleFileUpload(event)"
          />
          <button
            class="btn"
            onclick="document.getElementById('ruleFileInput').click()"
            style="
              padding: 8px 16px;
              font-size: 14px;
              background: #667eea;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
            "
          >
            üìÅ Upload Rule JSON
          </button>
          <span
            id="uploadStatus"
            style="margin-left: 10px; color: #28a745; font-weight: bold"
          ></span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">
          üìä Overview
        </button>
        <button class="tab" onclick="switchTab('pairs')">
          üìã Condition-Dataflow Pairs
        </button>
        <button class="tab" onclick="switchTab('simulator')">
          üéÆ Interactive Simulator
        </button>
        <button class="tab" onclick="switchTab('tests')">‚úÖ Test Cases</button>
        <button class="tab" onclick="switchTab('graph')">üï∏Ô∏è Graph View</button>
      </div>

      <div id="overview-tab" class="tab-content active">
        <h2>Rule Overview</h2>
        <div class="rule-info">
          <h3>Loaded Rule: <span id="rule-file"></span></h3>
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Instruction</div>
              <div class="info-value" id="instruction" style="font-family: monospace;"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Architecture</div>
              <div class="info-value" id="arch"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Registers</div>
              <div class="info-value" id="num-regs"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Memory Slots</div>
              <div class="info-value" id="num-mem"></div>
            </div>
            <div class="info-item">
              <div class="info-label">Condition-Dataflow Pairs</div>
              <div class="info-value" id="num-pairs"></div>
            </div>
          </div>
        </div>

        <div id="registers-list"></div>
      </div>

      <div id="pairs-tab" class="tab-content">
        <h2>Condition-Dataflow Pairs</h2>
        <div class="pair-list" id="pair-list"></div>
      </div>

      <div id="simulator-tab" class="tab-content">
        <h2>Interactive Taint Simulator</h2>
        <p style="margin-bottom: 20px; color: #6c757d">
          Set input register values bit-by-bit, mark which bits are tainted, and
          see how taint propagates through the instruction.
        </p>

        <div class="simulator">
          <!-- Top control bar -->
          <div
            style="
              margin-bottom: 20px;
              padding: 15px;
              background: #f8f9fa;
              border-radius: 8px;
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
              align-items: center;
            "
          >
            <!-- Input method selector -->
            <div style="display: flex; gap: 5px">
              <button
                class="btn"
                onclick="
                  window.switchInputMode('bits');
                  return false;
                "
                id="btnInputBits"
                style="background: #667eea; padding: 8px 16px"
              >
                Bit-by-Bit Input
              </button>
              <button
                class="btn"
                onclick="
                  window.switchInputMode('hex');
                  return false;
                "
                id="btnInputHex"
                style="background: #e0e0e0; color: #333; padding: 8px 16px"
              >
                Hex Input
              </button>
            </div>

            <div style="width: 2px; height: 30px; background: #dee2e6"></div>

            <!-- Edit/Taint mode toggle -->
            <button
              id="btnToggleEditMode"
              class="btn"
              onclick="
                window.toggleEditMode();
                return false;
              "
              style="background: #ff9800; padding: 8px 16px"
            >
              üé® Taint Mode
            </button>

            <div style="width: 2px; height: 30px; background: #dee2e6"></div>

            <!-- Bulk taint controls -->
            <button
              id="btnTaintAll"
              class="btn"
              onclick="
                window.taintAll();
                return false;
              "
              style="background: #ff9800; padding: 8px 16px"
            >
              Taint All
            </button>
            <button
              id="btnClearTaint"
              class="btn"
              onclick="
                window.clearTaint();
                return false;
              "
              style="background: #757575; padding: 8px 16px"
            >
              Clear Taint
            </button>
          </div>

          <!-- Mode description -->
          <p
            id="editModeText"
            style="
              color: #ff9800;
              font-size: 13px;
              margin: -10px 0 15px 0;
              padding-left: 15px;
            "
          >
            Click bits to mark them as tainted (orange).
          </p>

          <!-- Hex input mode -->
          <div
            id="hex-input-mode"
            style="
              display: none;
              margin-bottom: 20px;
              padding: 15px;
              background: white;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            "
          >
            <h4 style="margin: 0 0 10px 0; color: #667eea">Enter Hex Value</h4>
            <div class="input-group">
              <label
                for="input-state-hex"
                style="display: block; margin-bottom: 5px; font-weight: 500"
                >Input State (Hex):</label
              >
              <input
                type="text"
                id="input-state-hex"
                placeholder="0x1234 or 4660"
                value="0x0"
                oninput="
                  window.updateBitsFromHex();
                  return false;
                "
                style="
                  width: 100%;
                  padding: 8px;
                  border: 1px solid #ddd;
                  border-radius: 4px;
                  font-family: monospace;
                  font-size: 14px;
                "
              />
              <p style="margin: 5px 0 0 0; font-size: 12px; color: #666">
                Enter a hexadecimal value (e.g., 0xFF) or decimal number. The
                registers below will update automatically.
              </p>
            </div>
          </div>

          <!-- Bit-by-bit input mode -->
          <div id="bit-input-mode">
            <h3>Input Registers</h3>
            <div id="register-inputs"></div>
          </div>

          <div
            class="results"
            id="simulation-results-detailed"
            style="margin-top: 20px"
          >
            <h3>Output Registers</h3>
            <div id="output-registers"></div>
          </div>

          <!-- Enhanced condition matcher -->
          <div
            style="
              margin-top: 40px;
              padding-top: 20px;
              border-top: 2px solid #e0e0e0;
            "
          >
            <h3>Condition Matcher</h3>
            <p style="color: #6c757d; font-size: 14px">
              Shows which conditions match the current input register state.
              Automatically evaluates as you change the registers above.
            </p>

            <div style="display: flex; gap: 8px; margin-bottom: 15px">
              <button
                onclick="toggleConditionMatcherView('dnf')"
                id="matcherViewToggleDNF"
                style="
                  padding: 8px 16px;
                  background: #667eea;
                  color: white;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 600;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                "
              >
                üìù DNF Text
              </button>
              <button
                onclick="toggleConditionMatcherView('bitmask')"
                id="matcherViewToggleBitmask"
                style="
                  padding: 8px 16px;
                  background: #e0e0e0;
                  color: #333;
                  border: none;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 13px;
                  font-weight: 600;
                  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                "
              >
                üé® Visual Bitmask
              </button>
            </div>

            <div class="results" id="simulation-results">
              <div id="matching-pairs"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="tests-tab" class="tab-content">
        <h2>Generated Test Cases</h2>
        <p style="margin-bottom: 20px; color: #6c757d">
          Concrete test cases that exercise each condition-dataflow pair.
        </p>
        <div class="test-cases" id="test-cases"></div>
      </div>

      <div id="graph-tab" class="tab-content">
        <div class="graph-container">
          <h2>Taint Flow Visualization</h2>

          <div class="pair-selector">
            <label for="pairSelect">Select Condition-Dataflow Pair:</label>
            <select id="pairSelect" onchange="renderGraph()">
              <!-- Populated by JavaScript -->
            </select>
          </div>

          <div class="register-display" id="registerDisplay">
            <!-- Populated by JavaScript -->
          </div>

          <div style="display: flex; gap: 20px">
            <div style="flex: 1; min-width: 0">
              <div class="graph-scroll-wrapper">
                <svg id="flowGraph" class="graph-svg">
                  <!-- Populated by JavaScript -->
                </svg>
              </div>
            </div>

            <div
              id="edgeDetailsPanel"
              style="
                width: 350px;
                background: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                max-height: 600px;
                overflow-y: auto;
                display: none;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 10px;
                  border-bottom: 2px solid #dee2e6;
                  padding-bottom: 10px;
                "
              >
                <h3 style="margin: 0; font-size: 16px; color: #333">
                  Edge Conditions
                </h3>
                <button
                  onclick="
                    document.getElementById('edgeDetailsPanel').style.display =
                      'none'
                  "
                  style="
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    color: #666;
                  "
                >
                  &times;
                </button>
              </div>
              <div
                id="edgeDetailsContent"
                style="color: #333; font-size: 13px; line-height: 1.6"
              >
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="/static/utils.js"></script>
    <script src="/static/conditions.js"></script>
    <script src="/static/ui.js"></script>
    <script src="/static/api.js"></script>
    <script src="/static/graph.js"></script>
    <script src="/static/simulator.js"></script>
    <script src="/static/visualizer-new.js"></script>
  </body>
</html>
